
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø±ÙŠØ§Ù† 4</title>
<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#0f1724;
  --accent:#0b57d0;
  --muted:#6b7280;
  --danger:#ff3b30;
  --warning:#ff9f0a;
  --glass: rgba(11,87,208,0.06);
}
[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f1724;
  --text:#e6eef8;
  --accent:#3da0ff;
  --muted:#94a3b8;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); padding:18px; }
.header { display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:12px }
.header-logo img{ width:64px; height:64px; border-radius:10px; background:var(--card); padding:8px; box-shadow:0 6px 18px var(--glass)}
.header h1{ margin:0; font-size:18px }
.controls { display:flex; gap:8px; justify-content:center; margin-bottom:12px }
.card { background:var(--card); padding:14px; border-radius:12px; margin-bottom:14px; box-shadow:0 6px 18px var(--glass); }
.row{display:flex;gap:8px}
.input, select, button, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:15px;margin-bottom:10px}
select,input[type=number]{-moz-appearance:textfield}
button.primary{background:var(--accent);color:white;border:none}
button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
.totals{display:flex;gap:8px;flex-wrap:wrap}
.total{flex:1;min-width:140px;padding:12px;border-radius:10px;background:var(--card);box-shadow:0 4px 12px var(--glass);border:1px solid rgba(0,0,0,0.05);}
.total h4{margin:0;font-size:13px;color:var(--muted)}
.total p{margin:8px 0 0 0;font-size:18px;font-weight:700}
.entry{padding:10px;border-bottom:1px dashed rgba(0,0,0,0.05)}
.entry .meta{font-size:13px;color:var(--muted)}
.action-buttons{display:flex;gap:6px;justify-content:flex-start;margin-top:8px}
.btn-edit{background:var(--warning);border:none;padding:6px 10px;border-radius:8px}
.btn-del{background:var(--danger);border:none;padding:6px 10px;border-radius:8px;color:white}
.small{font-size:13px;color:var(--muted)}
.print-page{display:none}
.footer-note{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
.modal {
  display: none; /* Hidden by default, controlled by JS */
  position: fixed;
  z-index: 100; /* Above everything else */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6); /* Dark overlay */
  align-items: center;
  justify-content: center;
}
.modal-content {
  /* ... existing styles ... */
}
.backup-alert {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: var(--warning);
  color: var(--text);
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 99;
  display: none;
  max-width: 300px;
  text-align: right;
}
.backup-alert button {
  margin-top: 10px;
  width: 100%;
}
  /* ... existing styles ... */
}
.login-modal {
  display: flex; /* Initially visible until logged in */
  position: fixed;
  z-index: 101; /* Higher than edit modal */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bg);
  align-items: center;
  justify-content: center;
  flex-direction: column;
  padding: 20px;
}
.login-content {
  background-color: var(--card);
  padding: 30px;
  border-radius: 12px;
  width: 90%;
  max-width: 350px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  gap: 15px;
  border-top: 5px solid var(--accent); /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø¬Ø°Ø§Ø¨ */
}
.login-content h3 {
  margin-top: 0;
  text-.modal-content {
  background-color: var(--card);
  margin: auto;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  gap: 10px;
  border-left: 5px solid var(--accent); /* Ø´Ø±ÙŠØ· Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ù†ÙŠÙ‚ */
}
@media(min-width:800px){.container{max-width:900px;margin:0 auto}}
</style>
</head>
<body>
<div class="header">
  <div class="header-logo"><img src="https://cdn-icons-png.flaticon.com/512/69/69524.png" alt="Ø¹Ù…Ø§Ø±Ø©"></div>
  <div>
    <h1>Ø¥Ø¯Ø§Ø±Ø© ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø±ÙŠØ§Ù† 4</h1>
    <div class="small">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ â€” Ù…ØµÙ…Ù‘Ù… Ù„Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</div>
  </div>
</div>

<div class="controls" id="mainControls" style="display:none;">
  <button class="primary" onclick="toggleTheme()">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·</button>
  <button class="ghost" onclick="downloadBackup()">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
  <button class="ghost" onclick="restoreBackup()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
  <button class="ghost" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="card" id="totalsCard" style="display:none;">
  <div class="totals">
    <div class="total">
      <h4>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</h4>
      <p id="balanceTotal">0 Ø´ÙŠÙƒÙ„</p>
    </div>
    <div class="total">
      <h4>ÙƒØ§Ø´</h4>
      <p id="balanceCash">0 Ø´ÙŠÙƒÙ„</p>
    </div>
    <div class="total">
      <h4>ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ</h4>
      <p id="balanceApp">0 Ø´ÙŠÙƒÙ„</p>
    </div>
    <div class="total">
      <h4>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</h4>
      <p id="balanceRemaining">0 Ø´ÙŠÙƒÙ„</p>
    </div>
  </div>
  <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
    <div class="small">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <strong id="totalExpenses">0</strong> Ø´ÙŠÙƒÙ„</div>
    <div class="small">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: <strong id="totalPurchases">0</strong> Ø´ÙŠÙƒÙ„</div>
    <div class="small">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø®Ù„: <strong id="totalIncome">0</strong> Ø´ÙŠÙƒÙ„</div>
  </div>
</div>

<div class="card" id="addEntryCard" style="display:none;">
  <h3>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
  <div class="row">
    <select id="type" class="input" style="max-width:180px">
      <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
      <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
      <option value="Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</option>
    </select>
    <select id="category" class="input" style="max-width:180px">
      <option value="">ØªØµÙ†ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
      <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
      <option value="ÙÙˆØ§ØªÙŠØ±">ÙÙˆØ§ØªÙŠØ±</option>
      <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
      <option value="Ù…Ø´ØªØ±ÙŠØ§Øª">Ù…Ø´ØªØ±ÙŠØ§Øª</option>
      <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option>
      <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
    </select>
      <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
      <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
      <option value="Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</option>
    </select>
    <select id="paymentSource" class="input" style="max-width:180px">
      <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
      <option value="ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ">ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ</option>
    </select>
    <input type="date" id="entryDate" class="input" style="max-width:180px" />
      <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
      <option value="ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ">ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ</option>
    </select>
  </div>
  <input id="source" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù…ØµØ¯Ø±/Ø§Ù„Ù…Ø³ØªÙÙŠØ¯" style="margin-top: 0;" />
  <input id="amount" class="input" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø´ÙŠÙƒÙ„)" style="margin-top: 0;" />
  <textarea id="notes" class="input" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-top: 0;"></textarea>
  <div class="row" style="margin-top:10px">
    <button class="primary" onclick="addEntry()">â• Ø¥Ø¶Ø§ÙØ©</button>
    <button class="ghost" onclick="clearForm()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
  </div>
</div>

<div class="card" id="logCard" style="display:none;">
  <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
  <input type="text" id="search" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" onkeyup="renderLog()" />
  <div class="row" style="margin-bottom:10px;">
    <select id="displayLimit" class="input" style="max-width:150px;" onchange="renderLog()">
      <option value="5">Ø¹Ø±Ø¶ 5 Ø­Ø±ÙƒØ§Øª</option>
      <option value="10">Ø¹Ø±Ø¶ 10 Ø­Ø±ÙƒØ§Øª</option>
      <option value="20">Ø¹Ø±Ø¶ 20 Ø­Ø±ÙƒØ©</option>
      <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
    </select>
    <select id="monthFilter" class="input" onchange="renderLog()">
      <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
    </select>
    <select id="filterType" class="input" onchange="renderLog()">
      <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
      <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
      <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
      <option value="Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</option>
    </select>
    <select id="filterPayment" class="input" onchange="renderLog()">
      <option value="">ÙƒÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</option>
      <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
      <option value="ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ">ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ</option>
    </select>
  </div>
  <div id="log"></div>
</div>

<div class="card" id="exportCard" style="display:none;">
  <h3>ØªØµØ¯ÙŠØ± / Ù…Ø¹Ø§ÙŠÙ†Ø©</h3>
  <div class="row">
    <button class="primary" onclick="exportCSV()">ğŸ“„ ØªØµØ¯ÙŠØ± CSV</button>
    <button class="ghost" onclick="previewReport()">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    <button class="ghost" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
  </div>
  <div class="footer-note">Ù…Ù„Ù CSV ÙˆÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</div>
</div>

<div class="print-page" id="printPage">
  <h2>ØªÙ‚Ø±ÙŠØ± Ø¥Ø¯Ø§Ø±Ø© ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù…Ø§Ø±Ø© Ø§Ù„Ø±ÙŠØ§Ù† 4</h2>
  <p>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ: <span id="printTotal">0</span> Ø´ÙŠÙƒÙ„</p>
  <p>ÙƒØ§Ø´: <span id="printCash">0</span> Ø´ÙŠÙƒÙ„</p>
  <p>ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ: <span id="printApp">0</span> Ø´ÙŠÙƒÙ„</p>
  <p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: <span id="printRemaining">0</span> Ø´ÙŠÙƒÙ„</p>
  <p>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <span id="printExpenses">0</span> Ø´ÙŠÙƒÙ„</p>
  <p>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: <span id="printPurchases">0</span> Ø´ÙŠÙƒÙ„</p>
  <hr>
  <table>
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ©</th>
        <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</th>
        <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="printLog"></tbody>
  </table>
</div>

<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©</h3>
    <input type="text" id="editSource" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ©" />
    <input type="number" id="editAmount" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
    <input type="date" id="editDate" class="input" />
    <select id="editType" class="input">
      <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
      <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
      <option value="Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</option>
    </select>
    <select id="editCategory" class="input">
      <option value="">ØªØµÙ†ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
      <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
      <option value="ÙÙˆØ§ØªÙŠØ±">ÙÙˆØ§ØªÙŠØ±</option>
      <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
      <option value="Ù…Ø´ØªØ±ÙŠØ§Øª">Ù…Ø´ØªØ±ÙŠØ§Øª</option>
      <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option>
      <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
    </select>
      <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
      <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
      <option value="Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</option>
    </select>
    <select id="editPayment" class="input">
      <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
      <option value="ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ">ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†ÙƒÙŠ</option>
    </select>
    <textarea id="editNotes" class="input" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveEdit" class="primary">ğŸ’¾ Ø­ÙØ¸</button>
      <button onclick="closeModal()" class="ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
let editIndex = null;
const DEFAULT_PASSWORD = 'admin'; // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
let password = localStorage.getItem('amarah_password') || DEFAULT_PASSWORD;
let data = JSON.parse(localStorage.getItem('amarah') || '[]');
let theme = localStorage.getItem('amarah_theme') || 'light';
if(theme === 'dark') document.documentElement.setAttribute('data-theme','dark');

function formatPrint(x){ return (Number(x)||0).toFixed(2) + ' Ø´ÙŠÙƒÙ„' }



function renderLog(){
  const log = document.getElementById('log'); log.innerHTML='';
  const searchTerm = document.getElementById('search').value.toLowerCase();
  const filterType = document.getElementById('filterType').value;
  const filterPayment = document.getElementById('filterPayment').value;
  const monthFilter = document.getElementById('monthFilter').value;

  // Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
  const sortedData = [...data].reverse();

  const filteredData = sortedData.filter(it => {
    const matchesSearch = it.source.toLowerCase().includes(searchTerm) || (it.notes && it.notes.toLowerCase().includes(searchTerm));
    const matchesType = !filterType || it.type === filterType;
    const matchesPayment = !filterPayment || it.paymentSource === filterPayment;
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø±
    const entryDate = new Date(it.date);
    const entryMonthYear = `${entryDate.getFullYear()}-${(entryDate.getMonth() + 1).toString().padStart(2, '0')}`;
    const matchesMonth = !monthFilter || entryMonthYear === monthFilter;

    return matchesSearch && matchesType && matchesPayment && matchesMonth;
  });

  const displayLimit = document.getElementById('displayLimit').value;
  // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
  const sortedData = filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

  const displayLimit = document.getElementById('displayLimit').value;
  const limitedData = displayLimit === 'all' ? sortedData : sortedData.slice(0, parseInt(displayLimit));

  limitedData.forEach((it,i)=>{
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `\n      <div style="display:flex;justify-content:space-between;align-items:center">\n        <div>\n          <strong>${it.source}</strong><div class=\"meta\">${it.type} â€” ${it.paymentSource} â€” ${it.date}</div>\n        </div>\n        <div style=\"text-align:left\">\n          <div style=\"font-weight:700;margin-bottom:6px\">${(it.amount||0).toFixed(2)} Ø´ÙŠÙƒÙ„</div>\n          <div class=\"action-buttons\">\n            <button class=\"btn-edit\" onclick=\"openEditModal(${i})\">ØªØ¹Ø¯ÙŠÙ„</button>\n            <button class=\"btn-del\" onclick=\"deleteEntry(${i})\">Ø­Ø°Ù</button>\n          </div>\n        </div>\n      </div>`;
    if(it.notes) div.innerHTML += `<div class=\"small\">Ù…Ù„Ø§Ø­Ø¸Ø©: ${it.notes}</div>`;
    log.appendChild(div);
  });
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
  const logCard = document.getElementById('logCard');
  const countDiv = document.createElement('div');
  countDiv.className = 'small';
  countDiv.style.textAlign = 'center';
  countDiv.textContent = `Ø¹Ø±Ø¶ ${limitedData.length} Ù…Ù† Ø£ØµÙ„ ${filteredData.length} Ø­Ø±ÙƒØ© Ù…Ø·Ø§Ø¨Ù‚Ø©`;
  log.appendChild(countDiv);

  updateBalances(filteredData);
}

function updateBalances(dataToUse = data){
  let balanceCash = 0, balanceApp = 0, totalExpenses=0, totalPurchases=0, totalIncome=0;
  dataToUse.forEach(it=>{
    if(it.paymentSource === 'ÙƒØ§Ø´'){
      balanceCash += (it.type==='Ù…ØµØ±ÙˆÙ'||it.type==='Ø´Ø±Ø§Ø¡')? -it.amount: it.amount;
    } else { balanceApp += (it.type==='Ù…ØµØ±ÙˆÙ'||it.type==='Ø´Ø±Ø§Ø¡')? -it.amount: it.amount; }
    if(it.type==='Ù…ØµØ±ÙˆÙ') totalExpenses += it.amount;
    if(it.type==='Ø´Ø±Ø§Ø¡') totalPurchases += it.amount;
    if(it.type==='Ø¯Ø®Ù„') totalIncome += it.amount;
  });
  document.getElementById('balanceCash').textContent = formatPrint(balanceCash);
  document.getElementById('balanceApp').textContent = formatPrint(balanceApp);
  const totalBalance = balanceCash + balanceApp;
  document.getElementById('balanceTotal').textContent = formatPrint(totalBalance);
  document.getElementById('balanceRemaining').textContent = formatPrint(totalBalance);

  // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù†
  document.getElementById('balanceTotal').style.color = totalBalance >= 0 ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('balanceRemaining').style.color = totalBalance >= 0 ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('balanceCash').style.color = balanceCash >= 0 ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('balanceApp').style.color = balanceApp >= 0 ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('totalExpenses').textContent = formatPrint(totalExpenses);
  document.getElementById('totalPurchases').textContent = formatPrint(totalPurchases);
  document.getElementById('totalIncome').textContent = formatPrint(totalIncome);
}

function addEntry(){
  const type = document.getElementById('type').value;
  const category = document.getElementById('category').value;
  const paymentSource = document.getElementById('paymentSource').value;
  const source = document.getElementById('source').value.trim();
  const amount = Number(document.getElementById('amount').value);
  const notes = document.getElementById('notes').value.trim();
  if(!source || !amount) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ù…Ø¨Ù„Øº');
  const dateInput = document.getElementById('entryDate').value;
  const date = dateInput ? new Date(dateInput).toLocaleString('ar-EG') : new Date().toLocaleString('ar-EG');
  data.push({type,category,paymentSource,source,amount,date,notes});
  document.getElementById('entryDate').value = '';
  localStorage.setItem('amarah', JSON.stringify(data));
  document.getElementById('source').value=''; document.getElementById('amount').value=''; document.getElementById('notes').value='';
  renderLog();
}

function deleteEntry(i){ if(!confirm('Ø£ÙƒÙŠØ¯ ØªØ±ÙŠØ¯ ØªØ­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')) return; data.splice(i,1); localStorage.setItem('amarah', JSON.stringify(data)); renderLog(); }

function openEditModal(i){ 
  const it=data[i]; 
  editIndex=i; 
  document.getElementById('editSource').value=it.source; 
  document.getElementById('editAmount').value=it.amount; 
  document.getElementById('editType').value=it.type; 
  document.getElementById('editPayment').value=it.paymentSource; 
  document.getElementById('editNotes').value=it.notes||''; 
  document.getElementById('editCategory').value=it.category||''; 
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ar-EG Ø¥Ù„Ù‰ ØµÙŠØºØ© yyyy-mm-dd
  const dateObj = new Date(it.date);
  const formattedDate = dateObj.getFullYear() + '-' + 
                        (dateObj.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                        dateObj.getDate().toString().padStart(2, '0');
  document.getElementById('editDate').value = formattedDate;

  document.getElementById('editModal').style.display='flex'; 
}

document.getElementById('saveEdit').addEventListener('click', function(){ 
  const newSource=document.getElementById('editSource').value.trim(); 
  const newAmount=Number(document.getElementById('editAmount').value); 
  const newDateInput=document.getElementById('editDate').value;
  const newType=document.getElementById('editType').value; 
  const newCategory=document.getElementById('editCategory').value;
  const newPayment=document.getElementById('editPayment').value; 
  const newNotes=document.getElementById('editNotes').value; 
  
  if(!newSource||!newAmount) return alert('Ø§ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„'); 
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ ØµÙŠØºØ© ar-EG
  const newDate = new Date(newDateInput).toLocaleString('ar-EG');

  data[editIndex]={
    source:newSource,
    amount:newAmount,
    date:newDate,
    type:newType,
    category:newCategory,
    paymentSource:newPayment,
    notes:newNotes
  }; 
  localStorage.setItem('amarah',JSON.stringify(data)); 
  closeModal(); 
  renderLog(); 
});

function closeModal(){ document.getElementById('editModal').style.display='none'; }

function openChangePasswordModal(){
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('changePasswordModal').style.display = 'flex';
}

function closeChangePasswordModal(){
  document.getElementById('changePasswordModal').style.display = 'none';
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¯Ø®ÙˆÙ„Ù‡ØŒ Ø£Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
  if (!localStorage.getItem('amarah_loggedIn')) {
    document.getElementById('loginModal').style.display = 'flex';
  }
}

function login(){
  const input = document.getElementById('passwordInput').value;
  
  if (input === password) {
    localStorage.setItem('amarah_loggedIn', 'true');
    document.getElementById('loginModal').style.display = 'none';
    showMainContent();
    renderLog();
  } else {
    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
  }
}

function logout(){
  localStorage.removeItem('amarah_loggedIn');
  document.getElementById('loginModal').style.display = 'flex';
  hideMainContent();
}

function changePassword(){
  const oldPass = document.getElementById('oldPasswordInput').value;
  const newPass = document.getElementById('newPasswordInput').value;
  const confirmPass = document.getElementById('confirmNewPasswordInput').value;

  if (oldPass !== password) {
    return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
  }
  if (newPass.length < 4) {
    return alert('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  }
  if (newPass !== confirmPass) {
    return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†');
  }

  password = newPass;
  localStorage.setItem('amarah_password', newPass);
  alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!');
  closeChangePasswordModal();
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¯Ø®ÙˆÙ„Ù‡ØŒ Ø£Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  if (localStorage.getItem('amarah_loggedIn')) {
    showMainContent();
  }
}

function checkLogin(){
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ØŒ Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  if (!localStorage.getItem('amarah_password')) {
    localStorage.setItem('amarah_password', DEFAULT_PASSWORD);
  }
  
  if (localStorage.getItem('amarah_loggedIn') === 'true') {
    document.getElementById('loginModal').style.display = 'none';
    showMainContent();
    renderLog();
  } else {
    document.getElementById('loginModal').style.display = 'flex';
    hideMainContent();
  }
}

function showMainContent(){
  document.getElementById('mainControls').style.display = 'flex';
  document.getElementById('totalsCard').style.display = 'block';
  document.getElementById('addEntryCard').style.display = 'block';
  document.getElementById('logCard').style.display = 'block';
  document.getElementById('exportCard').style.display = 'block';
}

function hideMainContent(){
  document.getElementById('mainControls').style.display = 'none';
  document.getElementById('totalsCard').style.display = 'none';
  document.getElementById('addEntryCard').style.display = 'none';
  document.getElementById('logCard').style.display = 'none';
  document.getElementById('exportCard').style.display = 'none';
}

function clearForm(){ document.getElementById('source').value=''; document.getElementById('amount').value=''; document.getElementById('notes').value=''; }

function populateMonthFilter(){
  const monthFilter = document.getElementById('monthFilter');
  monthFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
  
  const uniqueMonths = new Set();
  data.forEach(it => {
    const date = new Date(it.date);
    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    uniqueMonths.add(monthYear);
  });

  const sortedMonths = Array.from(uniqueMonths).sort().reverse();

  sortedMonths.forEach(monthYear => {
    const [year, month] = monthYear.split('-');
    const date = new Date(year, month - 1);
    const monthName = date.toLocaleString('ar-EG', { month: 'long', year: 'numeric' });
    const option = document.createElement('option');
    option.value = monthYear;
    option.textContent = monthName;
    monthFilter.appendChild(option);
  });
}

function exportCSV(){ 
  // ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ renderLog
  const searchTerm = document.getElementById('search').value.toLowerCase();
  const filterType = document.getElementById('filterType').value;
  const filterPayment = document.getElementById('filterPayment').value;
  const monthFilter = document.getElementById('monthFilter').value;

  const filteredData = data.filter(it => {
    const matchesSearch = it.source.toLowerCase().includes(searchTerm) || (it.notes && it.notes.toLowerCase().includes(searchTerm));
    const matchesType = !filterType || it.type === filterType;
    const matchesPayment = !filterPayment || it.paymentSource === filterPayment;
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø±
    const entryDate = new Date(it.date);
    const entryMonthYear = `${entryDate.getFullYear()}-${(entryDate.getMonth() + 1).toString().padStart(2, '0')}`;
    const matchesMonth = !monthFilter || entryMonthYear === monthFilter;

    return matchesSearch && matchesType && matchesPayment && matchesMonth;
  });

  if(!filteredData.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ± Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.'); 
  
  let csv='Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ©,Ø§Ù„ØªØµÙ†ÙŠÙ,Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©,Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹,Ø§Ù„Ù…Ø¨Ù„Øº,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n'; 
  filteredData.forEach(it=>{ 
    csv+=`${it.source},${it.category||''},${it.type},${it.paymentSource},${it.amount},${it.date},${(it.notes||'')}\n`; 
  }); 
  
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download='ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¹Ù…Ø§Ø±Ø©_Ù…ÙÙ„ØªØ±.csv'; 
  document.body.appendChild(a); 
  a.click(); 
  document.body.removeChild(a); 
}

function previewReport(){ const tbody=document.getElementById('printLog'); tbody.innerHTML=''; data.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.source}</td><td>${it.type}</td><td>${it.paymentSource}</td><td>${it.amount}</td><td>${it.date}</td><td>${it.notes||''}</td>`; tbody.appendChild(tr); }); updateBalances(); document.getElementById('printCash').textContent=document.getElementById('balanceCash').textContent; document.getElementById('printApp').textContent=document.getElementById('balanceApp').textContent; document.getElementById('printTotal').textContent=document.getElementById('balanceTotal').textContent; document.getElementById('printRemaining').textContent=document.getElementById('balanceRemaining').textContent; document.getElementById('printExpenses').textContent=document.getElementById('totalExpenses').textContent; document.getElementById('printPurchases').textContent=document.getElementById('totalPurchases').textContent; document.getElementById('printPage').style.display='block'; document.getElementById('printPage').scrollIntoView({behavior:'smooth'}); }

function printReport(){ previewReport(); setTimeout(()=>{ window.print(); },400); }

function toggleTheme(){ if(document.documentElement.getAttribute('data-theme')==='dark'){ document.documentElement.removeAttribute('data-theme'); localStorage.setItem('amarah_theme','light'); } else { document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('amarah_theme','dark'); } }

function downloadBackup(){ 
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download='amarah_backup.json'; 
  document.body.appendChild(a); 
  a.click(); 
  document.body.removeChild(a); 
  localStorage.setItem('lastBackupTime', Date.now()); // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
}

function restoreBackup(){ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=function(){ try{ const arr=JSON.parse(reader.result); if(Array.isArray(arr)){ data=arr; localStorage.setItem('amarah',JSON.stringify(data)); renderLog(); alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©'); } else alert('ØµÙŠØº Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); }catch(err){ alert('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'); } }; reader.readAsText(file); }; input.click(); }

function checkBackupAlert(){
  const lastBackupTime = localStorage.getItem('lastBackupTime');
  const sevenDays = 7 * 24 * 60 * 60 * 1000; // 7 Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙˆÙ‚Øª Ù„Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø£Ùˆ Ù…Ø± Ø£ÙƒØ«Ø± Ù…Ù† 7 Ø£ÙŠØ§Ù…
  if (!lastBackupTime || (Date.now() - lastBackupTime > sevenDays)) {
    document.getElementById('backupAlert').style.display = 'block';
  }
}

function hideBackupAlert(){
  document.getElementById('backupAlert').style.display = 'none';
  // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±Ø¶
populateMonthFilter();
checkLogin();
checkBackupAlert();
</script>

<div class="login-modal" id="loginModal">
  <div class="login-content">
    <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    
    <input type="password" id="passwordInput" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (admin)" />
    <button class="primary" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <button class="ghost" onclick="openChangePasswordModal()">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
  </div>
</div>

<div class="backup-alert" id="backupAlert">
  <p>Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 7 Ø£ÙŠØ§Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
  <button class="primary" onclick="downloadBackup(); hideBackupAlert()">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†</button>
  <button class="ghost" onclick="hideBackupAlert()">ØªØ¬Ø§Ù‡Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹</button>
</div>

<div class="modal" id="changePasswordModal">
  <div class="modal-content">
    <h3>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <input type="password" id="oldPasswordInput" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©" />
    <input type="password" id="newPasswordInput" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
    <input type="password" id="confirmNewPasswordInput" class="input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="primary" onclick="changePassword()">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      <button onclick="closeChangePasswordModal()" class="ghost">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

</body>
</html>
