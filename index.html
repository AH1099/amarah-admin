<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة عمارة الريان 4</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
body { background:#f5f5f5; }
.card p { font-size:20px; margin:0; }
</style>
</head>

<body>

<div class="container my-4">

<h3 class="text-center mb-4">نظام إدارة عمارة الريان 4</h3>

<div class="row text-center mb-3">
  <div class="col-md-4"><div class="card p-3">الرصيد الكلي<br><b id="total">0</b></div></div>
  <div class="col-md-4"><div class="card p-3">رصيد الكاش<br><b id="cash">0</b></div></div>
  <div class="col-md-4"><div class="card p-3">رصيد التطبيق<br><b id="app">0</b></div></div>
</div>

<div class="mb-3 d-flex gap-2">
  <button class="btn btn-success" onclick="add()">إضافة عملية</button>
  <button class="btn btn-primary" onclick="generatePDF()">تحميل تقرير PDF</button>
</div>

<table class="table table-bordered table-striped bg-white">
<thead class="table-dark">
<tr>
<th>التاريخ</th>
<th>النوع</th>
<th>الشقة</th>
<th>المالك</th>
<th>المبلغ</th>
<th>الرصيد</th>
<th>الوصف</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

</div>

<script>
/* ==== بيانات الشقق ==== */
const apartments = [
 {name:"طابق 1 - شقة 1", owner:"أحمد", phone:"0590000000"},
 {name:"طابق 1 - شقة 2", owner:"ليلى", phone:"0590000001"},
 {name:"طابق 2 - شقة 1", owner:"سالم", phone:"0590000002"}
];

/* ==== العمليات ==== */
let transactions = JSON.parse(localStorage.getItem("transactions")||"[]");

function add(){
 const apt = prompt("اسم الشقة");
 const type = prompt("دخل / مصروف");
 const amount = Number(prompt("المبلغ"));
 const balance = prompt("كاش / تطبيق");
 const desc = prompt("الوصف");

 if(!amount) return;

 transactions.push({
  date:new Date().toLocaleString('ar-EG'),
  type,
  apartment:apt,
  owner:getOwner(apt),
  amount,
  balance,
  desc
 });

 localStorage.setItem("transactions",JSON.stringify(transactions));
 render();
}

function getOwner(name){
 const a = apartments.find(x=>x.name===name);
 return a ? a.owner : "-";
}

function render(){
 let cash=0, app=0;
 const tbody=document.getElementById("table");
 tbody.innerHTML="";

 transactions.forEach(t=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`
   <td>${t.date}</td>
   <td>${t.type}</td>
   <td>${t.apartment}</td>
   <td>${t.owner}</td>
   <td>${t.amount}</td>
   <td>${t.balance}</td>
   <td>${t.desc}</td>`;
  tbody.appendChild(tr);

  if(t.balance==="كاش") cash += t.type==="دخل"?t.amount:-t.amount;
  else app += t.type==="دخل"?t.amount:-t.amount;
 });

 document.getElementById("cash").textContent=cash+" شيكل";
 document.getElementById("app").textContent=app+" شيكل";
 document.getElementById("total").textContent=(cash+app)+" شيكل";
}

render();

/* ==== PDF عربي ==== */
let AMIRI_FONT="";
fetch("https://cdn.jsdelivr.net/gh/alif-type/amiri@master/ttf/Amiri-Regular.ttf")
.then(res=>res.arrayBuffer())
.then(buf=>{
 AMIRI_FONT=btoa(String.fromCharCode(...new Uint8Array(buf)));
});

function generatePDF(){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF({orientation:"p",unit:"pt",format:"a4"});

 doc.addFileToVFS("Amiri.ttf", AMIRI_FONT);
 doc.addFont("Amiri.ttf","Amiri","normal");
 doc.setFont("Amiri");

 doc.setFontSize(16);
 doc.text("تقرير عمارة الريان 4",300,40,{align:"center"});

 const rows = transactions.map(t=>[
  t.date,t.type,t.apartment,t.owner,t.amount+" شيكل",t.balance,t.desc
 ]);

 doc.autoTable({
  startY:70,
  head:[["التاريخ","النوع","الشقة","المالك","المبلغ","الرصيد","الوصف"]],
  body:rows,
  styles:{font:"Amiri",halign:"right"}
 });

 doc.save("تقرير_العمارة.pdf");
}
</script>

</body>
</html>