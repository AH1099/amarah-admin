<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة عمارة الريان 4</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
.user-icon {cursor:pointer;}
#previewModal iframe {width:100%;height:80vh;border:none;}
</style>
</head>
<body class="bg-light">

<!-- شاشة تسجيل الدخول -->
<div class="modal show d-block" id="loginModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تسجيل الدخول</h5>
      </div>
      <div class="modal-body">
        <input type="text" id="usernameInput" class="form-control mb-2" placeholder="اسم المستخدم">
        <input type="password" id="passwordInput" class="form-control mb-2" placeholder="كلمة المرور">
        <p id="loginError" class="text-danger d-none">اسم المستخدم أو كلمة المرور خاطئة</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="login()">دخول</button>
      </div>
    </div>
  </div>
</div>

<div class="d-none" id="app">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-3">
    <div class="container-fluid">
      <span class="navbar-brand">نظام إدارة عمارة الريان 4</span>
      <div class="dropdown ms-auto">
        <span class="user-icon dropdown-toggle p-2" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle"></i> <span id="loggedUser">admin</span>
        </span>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" onclick="logout()">تسجيل خروج</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- لوحة الأرصدة -->
    <div class="row mb-4 text-center">
      <div class="col-md-4 mb-2"><div class="card p-3"><h5>الرصيد الكلي</h5><p id="totalBalance" class="fs-4">0 شيكل</p></div></div>
      <div class="col-md-4 mb-2"><div class="card p-3"><h5>رصيد الكاش</h5><p id="cashBalance" class="fs-4">0 شيكل</p></div></div>
      <div class="col-md-4 mb-2"><div class="card p-3"><h5>رصيد التطبيق</h5><p id="appBalance" class="fs-4">0 شيكل</p></div></div>
    </div>

    <!-- أزرار العمليات والتقارير -->
    <div class="mb-3 d-flex justify-content-start gap-2">
      <button class="btn btn-success" onclick="showAddModal()">إضافة عملية</button>
      <button class="btn btn-info" onclick="previewReport()">معاينة التقرير</button>
      <button class="btn btn-primary" onclick="generateReports()">تحميل PDF</button>
    </div>

    <!-- جدول العمليات -->
    <div class="table-responsive mb-4">
      <table class="table table-bordered table-striped" id="transactionsTable">
        <thead class="table-dark">
          <tr>
            <th>التاريخ</th>
            <th>نوع العملية</th>
            <th>الشقة</th>
            <th>المالك</th>
            <th>المبلغ</th>
            <th>نوع الرصيد</th>
            <th>الوصف</th>
            <th>أدوات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- مودال إضافة عملية -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إضافة عملية</h5>
        <button type="button" class="btn-close" onclick="closeAddModal()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>نوع العملية</label>
          <select id="typeSelect" class="form-select">
            <option value="income">دخل</option>
            <option value="expense">مصروف</option>
          </select>
        </div>
        <div class="mb-2">
          <label>الشقة (للدخل فقط)</label>
          <select id="apartmentSelect" class="form-select">
            <option value="">اختر الشقة</option>
          </select>
        </div>
        <div class="mb-2">
          <label>نوع الرصيد</label>
          <select id="balanceTypeSelect" class="form-select">
            <option value="cash">كاش</option>
            <option value="app">تطبيق</option>
          </select>
        </div>
        <div class="mb-2">
          <label>المبلغ</label>
          <input type="number" id="amountInput" class="form-control">
        </div>
        <div class="mb-2">
          <label>الوصف</label>
          <input type="text" id="descInput" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="addTransaction()">إضافة</button>
        <button class="btn btn-danger" onclick="closeAddModal()">إلغاء</button>
      </div>
    </div>
  </div>
</div>

<!-- مودال معاينة التقرير -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">معاينة التقرير</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <iframe id="reportIframe"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;

// --- بيانات الشقق ---
const apartments=[
  {name:"طابق 1 - شقة 1", owner:"أحمد"},
  {name:"طابق 1 - شقة 2", owner:"ليلى"},
  {name:"طابق 1 - شقة 3", owner:"سالم"},
  {name:"طابق 1 - شقة 4", owner:"خالي"},
  {name:"طابق 2 - شقة 1", owner:"مأهولة؟"},
  {name:"طابق 2 - شقة 2", owner:"خالي"}
];
const apartmentSelect=document.getElementById("apartmentSelect");
apartments.forEach(a=>{
  if(a.owner && a.owner!=="خالي"){
    const opt=document.createElement("option");
    opt.value=a.name; opt.textContent=a.name + " - " + a.owner;
    apartmentSelect.appendChild(opt);
  }
});

let transactions=JSON.parse(localStorage.getItem("transactions"))||[];
let loggedUser="";

// --- تسجيل الدخول ---
function login(){
  const pw=document.getElementById("passwordInput").value;
  const user=document.getElementById("usernameInput").value || "admin";
  if(pw==="1234"){
    loggedUser=user;
    document.getElementById("loggedUser").textContent=loggedUser;
    document.getElementById("loginModal").classList.add("d-none");
    document.getElementById("app").classList.remove("d-none");
    renderTransactions();
  }else{
    document.getElementById("loginError").classList.remove("d-none");
  }
}

function logout(){
  loggedUser="";
  document.getElementById("usernameInput").value="";
  document.getElementById("passwordInput").value="";
  document.getElementById("loginError").classList.add("d-none");
  document.getElementById("app").classList.add("d-none");
  document.getElementById("loginModal").classList.remove("d-none");
}

// --- العمليات ---
function showAddModal(){new bootstrap.Modal(document.getElementById('addModal')).show();}
function closeAddModal(){bootstrap.Modal.getInstance(document.getElementById('addModal')).hide(); document.getElementById("amountInput").value="";document.getElementById("descInput").value="";document.getElementById("typeSelect").value="income";document.getElementById("apartmentSelect").value="";document.getElementById("balanceTypeSelect").value="cash";}

function addTransaction(){
  const type=document.getElementById("typeSelect").value;
  const apartment=document.getElementById("apartmentSelect").value;
  const balanceType=document.getElementById("balanceTypeSelect").value;
  const amount=parseFloat(document.getElementById("amountInput").value);
  const desc=document.getElementById("descInput").value;
  if(type==='income' && !apartment){alert("اختر الشقة للمدخل"); return;}
  if(!amount){alert("ادخل المبلغ"); return;}
  const t={date:new Date().toLocaleDateString(),type,apartment:type==='income'?apartment:'العمارة',balanceType,amount,desc};
  transactions.push(t);
  localStorage.setItem("transactions",JSON.stringify(transactions));
  closeAddModal();
  renderTransactions();
}

function deleteTransaction(index){
  if(confirm("هل أنت متأكد؟")){
    transactions.splice(index,1);
    localStorage.setItem("transactions",JSON.stringify(transactions));
    renderTransactions();
  }
}

function renderTransactions(){
  const tbody=document.querySelector("#transactionsTable tbody");
  tbody.innerHTML="";
  let cashBalance=0,appBalance=0;
  transactions.forEach((t,i)=>{
    const owner = getOwnerName(t.apartment);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t.date}</td><td>${t.type==="income"?"دخل":"مصروف"}</td><td>${t.apartment}</td><td>${owner}</td><td>${t.amount}</td><td>${t.balanceType==="cash"?"كاش":"تطبيق"}</td><td>${t.desc}</td><td><button class="btn btn-warning btn-sm me-1" onclick="editTransaction(${i})">تعديل</button><button class="btn btn-danger btn-sm" onclick="deleteTransaction(${i})">حذف</button></td>`;
    tbody.appendChild(tr);
    if(t.type==="income"){if(t.balanceType==="cash") cashBalance+=t.amount; else appBalance+=t.amount;}
    else{if(t.balanceType==="cash") cashBalance-=t.amount; else appBalance-=t.amount;}
  });
  document.getElementById("cashBalance").textContent=cashBalance+" شيكل";
  document.getElementById("appBalance").textContent=appBalance+" شيكل";
  document.getElementById("totalBalance").textContent=(cashBalance+appBalance)+" شيكل";
}

function editTransaction(index){
  const t=transactions[index];
  document.getElementById("typeSelect").value=t.type;
  document.getElementById("apartmentSelect").value=t.apartment!=="العمارة"?t.apartment:"";
  document.getElementById("amountInput").value=t.amount;
  document.getElementById("descInput").value=t.desc;
  document.getElementById("balanceTypeSelect").value=t.balanceType;
  showAddModal();
  deleteTransaction(index);
}

function getOwnerName(apartmentName){
  const a=apartments.find(a=>a.name===apartmentName);
  return a ? a.owner : "-";
}

// --- توليد PDF ---
function generateReports(){
  const doc=new jsPDF({orientation:'p',unit:'pt',format:'a4'}); let y=40;
  doc.setFontSize(16); doc.text("تقرير عمارة الريان 4",300,y,{align:'center'}); y+=30;
  const cashBalance=transactions.filter(t=>t.balanceType==="cash").reduce((a,t)=>t.type==="income"?a+t.amount:a-t.amount,0);
  const appBalance=transactions.filter(t=>t.balanceType==="app").reduce((a,t)=>t.type==="income"?a+t.amount:a-t.amount,0);
  const totalBalance=cashBalance+appBalance;
  doc.setFontSize(12);
  doc.text("تقرير العمارة بالكامل",40,y); y+=20;
  doc.text(`رصيد الكاش: ${cashBalance} شيكل`,40,y); y+=15;
  doc.text(`رصيد التطبيق: ${appBalance} شيكل`,40,y); y+=15;
  doc.text(`الرصيد الكلي: ${totalBalance} شيكل`,40,y); y+=25;

  apartments.forEach(apt=>{
    doc.text(`شقة: ${apt.name} - المالك: ${apt.owner}`,40,y); y+=15;
    const tapt=transactions.filter(t=>t.apartment===apt.name);
    if(tapt.length===0){doc.text("لا توجد عمليات",50,y); y+=15; return;}
    tapt.forEach(tr=>{
      doc.text(`${tr.date} | ${tr.type==="income"?"دخل":"مصروف"} | ${tr.amount} | ${tr.balanceType==="cash"?"كاش":"تطبيق"} | ${tr.desc}`,50,y);
      y+=12;
      if(y>750){doc.addPage(); y=40;}
    });
    y+=10;
  });

  doc.save("Amara_Report.pdf");
}

// --- معاينة التقرير ---
function previewReport(){
  const iframe=document.getElementById("reportIframe");
  const doc=new jsPDF({orientation:'p',unit:'pt',format:'a4'});
  let y=40;
  doc.setFontSize(16); doc.text("تقرير عمارة الريان 4",300,y,{align:'center'}); y+=30;
  const cashBalance=transactions.filter(t=>t.balanceType==="cash").reduce((a,t)=>t.type==="income"?a+t.amount:a-t.amount,0);
  const appBalance=transactions.filter(t=>t.balanceType==="app").reduce((a,t)=>t.type==="income"?a+t.amount:a-t.amount,0);
  const totalBalance=cashBalance+appBalance;
  doc.setFontSize(12);
  doc.text("تقرير العمارة بالكامل",40,y); y+=20;
  doc.text(`رصيد الكاش: ${cashBalance} شيكل`,40,y); y+=15;
  doc.text(`رصيد التطبيق: ${appBalance} شيكل`,40,y); y+=15;
  doc.text(`الرصيد الكلي: ${totalBalance} شيكل`,40,y); y+=25;
  apartments.forEach(apt=>{
    doc.text(`شقة: ${apt.name} - المالك: ${apt.owner}`,40,y); y+=15;
    const tapt=transactions.filter(t=>t.apartment===apt.name);
    if(tapt.length===0){doc.text("لا توجد عمليات",50,y); y+=15; return;}
    tapt.forEach(tr=>{
      doc.text(`${tr.date} | ${tr.type==="income"?"دخل":"مصروف"} | ${tr.amount} | ${tr.balanceType==="cash"?"كاش":"تطبيق"} | ${tr.desc}`,50,y);
      y+=12;
      if(y>750){doc.addPage(); y=40;}
    });
    y+=10;
  });

  // عرض التقرير داخل iframe
  iframe.src=doc.output('datauristring');
  new bootstrap.Modal(document.getElementById('previewModal')).show();
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</body>
</html>
