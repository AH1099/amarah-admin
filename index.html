<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة عمارة الريان 4</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
body{background:#f5f5f5}
#previewModal iframe{width:100%;height:80vh;border:none}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div class="modal show d-block" id="loginModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>تسجيل الدخول</h5></div>
      <div class="modal-body">
        <input id="username" class="form-control mb-2" placeholder="اسم المستخدم">
        <input id="password" type="password" class="form-control mb-2" placeholder="كلمة المرور">
        <div id="loginError" class="text-danger d-none">بيانات الدخول غير صحيحة</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary w-100" onclick="login()">دخول</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= APP ================= -->
<div id="app" class="d-none">

<nav class="navbar bg-white shadow-sm mb-3">
  <div class="container-fluid">
    <span class="navbar-brand">إدارة عمارة الريان 4</span>
    <div class="dropdown">
      <span class="dropdown-toggle" data-bs-toggle="dropdown">
        <i class="bi bi-person-circle"></i> <span id="loggedUser"></span>
      </span>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" onclick="logout()">تسجيل خروج</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">

<div class="row text-center mb-4">
  <div class="col-md-4 mb-2"><div class="card p-3">الرصيد الكلي<br><b id="total">0</b></div></div>
  <div class="col-md-4 mb-2"><div class="card p-3">رصيد الكاش<br><b id="cash">0</b></div></div>
  <div class="col-md-4 mb-2"><div class="card p-3">رصيد التطبيق<br><b id="appBal">0</b></div></div>
</div>

<div class="mb-3 d-flex gap-2">
  <button class="btn btn-success" onclick="showAdd()">إضافة عملية</button>
  <button class="btn btn-info" onclick="previewPDF()">معاينة التقرير</button>
  <button class="btn btn-primary" onclick="generatePDF()">تحميل PDF</button>
</div>

<table class="table table-bordered table-striped bg-white">
<thead class="table-dark">
<tr>
<th>التاريخ</th>
<th>النوع</th>
<th>الشقة</th>
<th>المالك</th>
<th>المبلغ</th>
<th>الرصيد</th>
<th>الوصف</th>
<th>أدوات</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

</div>
</div>

<!-- ================= ADD MODAL ================= -->
<div class="modal fade" id="addModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5>إضافة عملية</h5></div>
<div class="modal-body">
<select id="type" class="form-select mb-2">
<option value="دخل">دخل</option>
<option value="مصروف">مصروف</option>
</select>

<select id="apartment" class="form-select mb-2">
<option>طابق 1 - شقة 1</option>
<option>طابق 1 - شقة 2</option>
<option>طابق 2 - شقة 1</option>
</select>

<select id="balance" class="form-select mb-2">
<option>كاش</option>
<option>تطبيق</option>
</select>

<input id="amount" type="number" class="form-control mb-2" placeholder="المبلغ">
<input id="desc" class="form-control mb-2" placeholder="الوصف">
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="save()">حفظ</button>
</div>
</div>
</div>
</div>

<!-- ================= PREVIEW ================= -->
<div class="modal fade" id="previewModal">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header"><h5>معاينة التقرير</h5></div>
<div class="modal-body">
<iframe id="pdfFrame"></iframe>
</div>
</div>
</div>
</div>

<script>
const { jsPDF } = window.jspdf;
let transactions = JSON.parse(localStorage.getItem("transactions")||"[]");

/* LOGIN */
function login(){
 if(username.value==="admin" && password.value==="1234"){
  loggedUser.textContent="admin";
  loginModal.classList.add("d-none");
  app.classList.remove("d-none");
  render();
 }else loginError.classList.remove("d-none");
}
function logout(){ location.reload(); }

/* CRUD */
function showAdd(){ new bootstrap.Modal(addModal).show(); }
function save(){
 const t={
  date:new Date().toLocaleString('ar-EG'),
  type:type.value,
  apartment:apartment.value,
  owner:"—",
  amount:+amount.value,
  balance:balance.value,
  desc:desc.value
 };
 transactions.push(t);
 localStorage.setItem("transactions",JSON.stringify(transactions));
 bootstrap.Modal.getInstance(addModal).hide();
 render();
}

function render(){
 let cash=0,app=0;
 table.innerHTML="";
 transactions.forEach(t=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`
   <td>${t.date}</td><td>${t.type}</td><td>${t.apartment}</td>
   <td>${t.owner}</td><td>${t.amount}</td><td>${t.balance}</td>
   <td>${t.desc}</td>
   <td><button class="btn btn-danger btn-sm" onclick="del(${transactions.indexOf(t)})">حذف</button></td>`;
  table.appendChild(tr);

  if(t.balance==="كاش") cash+=t.type==="دخل"?t.amount:-t.amount;
  else app+=t.type==="دخل"?t.amount:-t.amount;
 });

 cash.innerText=cash+" شيكل";
 appBal.innerText=app+" شيكل";
 total.innerText=(cash+app)+" شيكل";
}

function del(i){
 transactions.splice(i,1);
 localStorage.setItem("transactions",JSON.stringify(transactions));
 render();
}

/* PDF */
let AMIRI_FONT="";
fetch("https://cdn.jsdelivr.net/gh/alif-type/amiri@master/ttf/Amiri-Regular.ttf")
.then(r=>r.arrayBuffer())
.then(b=>AMIRI_FONT=btoa(String.fromCharCode(...new Uint8Array(b))));

function generatePDF(){
 const doc=new jsPDF({unit:"pt",format:"a4"});
 doc.addFileToVFS("Amiri.ttf",AMIRI_FONT);
 doc.addFont("Amiri.ttf","Amiri","normal");
 doc.setFont("Amiri");

 doc.text("تقرير عمارة الريان 4",300,40,{align:"center"});

 doc.autoTable({
  startY:70,
  head:[["التاريخ","النوع","الشقة","المالك","المبلغ","الرصيد","الوصف"]],
  body:transactions.map(t=>[t.date,t.type,t.apartment,t.owner,t.amount,t.balance,t.desc]),
  styles:{font:"Amiri",halign:"right"}
 });

 doc.save("تقرير_العمارة.pdf");
}

function previewPDF(){
 const doc=new jsPDF();
 generatePDF();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>